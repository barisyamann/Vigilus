/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  */
/* USER CODE END Header */

#include "main.h"
#include "usb_host.h"
#include "mpu9250.h"
#include "bmp280.h"
#include "neo_m8n.h"
#include "xbee.h"

/* Private variables ---------------------------------------------------------*/
I2C_HandleTypeDef  hi2c1;
I2S_HandleTypeDef  hi2s3;
SPI_HandleTypeDef  hspi1;
UART_HandleTypeDef huart2;  // GPS - NEO-M8N
UART_HandleTypeDef huart3;  // XBee

/* USER CODE BEGIN PV */
MPU9250_Data imu = {0};
BMP280_Data  bmp = {0};
GPS_Data     gps = {0};
uint32_t     last_tick = 0;
/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_I2C1_Init(void);
static void MX_I2S3_Init(void);
static void MX_SPI1_Init(void);
static void MX_USART2_UART_Init(void);
static void MX_USART3_UART_Init(void);
void MX_USB_HOST_Process(void);

int main(void)
{
  HAL_Init();
  SystemClock_Config();

  MX_GPIO_Init();
  MX_I2C1_Init();
  MX_I2S3_Init();
  MX_SPI1_Init();
  MX_USB_HOST_Init();
  MX_USART2_UART_Init();
  MX_USART3_UART_Init();

  /* USER CODE BEGIN 2 */
  while (MPU9250_Init(&hi2c1) != HAL_OK) { HAL_Delay(100); }
  while (BMP280_Init(&hi2c1)  != HAL_OK) { HAL_Delay(100); }
  GPS_Init(&huart2);
  /* USER CODE END 2 */

  while (1)
  {
    /* USER CODE BEGIN WH     */
	  /* USER CODE BEGIN WHILE */
	  MX_USB_HOST_Process();

	  // 1Hz — sensör okuma ve gönderim
	  if (HAL_GetTick() - last_tick >= 1000)
	  {
	    last_tick = HAL_GetTick();

	    MPU9250_ReadAll(&hi2c1, &imu);
	    BMP280_Read(&hi2c1, &bmp);

	    // GPS interrupt'tan en son gelen veriyi al
	    GPS_GetLatest(&gps);

	    XBee_SendPacket(&huart3, &imu, &bmp, &gps);
	  }
	  /* USER CODE END WHILE */
  }
